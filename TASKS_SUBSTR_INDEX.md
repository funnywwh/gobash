# substr 和 index 算术函数实现任务分解

## 任务概述

实现 `substr(s, start, length)` 和 `index(s, t)` 算术函数，这两个函数需要字符串参数支持。当前算术表达式解析器只支持数字参数，需要进行架构扩展。

## 技术分析

### 当前架构限制

1. **参数解析器限制**：`parseArithmeticFunctionArgs` 只解析算术表达式，返回 `[]int64`
2. **函数调用限制**：`evaluateArithmeticFunction` 只接受 `[]int64` 参数
3. **字符串支持缺失**：算术表达式中无法直接传递字符串参数

### bash 中的用法

在 bash 中，`substr` 和 `index` 函数的使用方式：
```bash
# substr 函数
VAR="hello"
echo $((substr($VAR, 0, 3)))  # 输出子字符串（需要返回字符串，但算术展开返回数字）

# index 函数
VAR="hello"
echo $((index($VAR, "ll")))   # 输出 3（从 1 开始）
```

### 技术方案

1. **字符串参数获取方式**：
   - 通过变量展开：`$VAR` 在算术表达式展开前会被展开为字符串
   - 通过字符串字面量：`"string"` 或 `'string'`（需要解析器支持）

2. **参数解析扩展**：
   - 修改 `parseArithmeticFunctionArgs` 以支持混合参数类型
   - 创建新的参数结构体，包含数字参数和字符串参数
   - 在解析时识别字符串参数（变量展开或字符串字面量）

3. **函数调用扩展**：
   - 修改 `evaluateArithmeticFunction` 以接受混合参数
   - 对于需要字符串参数的函数，调用 `evaluateArithmeticFunctionWithStrings`

## 任务分解

### 子任务 1：分析需求和技术方案

**目标**：深入理解需求，确定技术实现方案

**步骤**：
1. 研究 bash 源码中 substr 和 index 的实现
2. 分析当前 `internal/executor/executor.go` 中的算术表达式解析器架构
3. 设计字符串参数支持方案
4. 确定需要修改的代码位置和函数
5. 编写技术方案文档

**验收标准**：
- [x] 完成技术方案文档（TECH_DESIGN_SUBSTR_INDEX.md）
- [x] 确定所有需要修改的函数和数据结构
- [x] 确定向后兼容性方案

**预计工作量**：1-2 小时

**完成情况**：
- ✅ 已完成技术方案文档 TECH_DESIGN_SUBSTR_INDEX.md
- ✅ 确定了数据结构设计（ArithmeticArgType, ArithmeticFunctionArg）
- ✅ 确定了需要修改的函数（parseArithmeticFunctionArgs, parseArithmeticFactor, evaluateArithmeticFunction）
- ✅ 确定了实现方案（方案 A + 方案 C 的混合方案）
- ✅ 确定了向后兼容性方案（保持现有函数逻辑不变）

---

### 子任务 2：扩展参数解析器以支持字符串参数

**目标**：修改参数解析器，使其能够识别和解析字符串参数

**步骤**：
1. 创建新的参数结构体 `ArithmeticFunctionArg`，支持数字和字符串类型
2. 修改 `parseArithmeticFunctionArgs` 函数签名，返回 `[]ArithmeticFunctionArg`
3. 实现 `parseArithmeticStringArg` 函数，解析字符串参数
4. 在 `parseArithmeticFunctionArgs` 中识别字符串参数：
   - 识别变量展开（如 `$VAR`，在展开后是字符串）
   - 识别字符串字面量（如 `"string"` 或 `'string'`）
5. 修改参数解析逻辑，区分数字参数和字符串参数
6. 添加单元测试

**验收标准**：
- [ ] `parseArithmeticFunctionArgs` 能够解析混合参数类型
- [ ] 能够正确识别变量展开为字符串的情况
- [ ] 能够正确识别字符串字面量
- [ ] 所有现有测试仍然通过
- [ ] 添加新的单元测试覆盖字符串参数解析

**预计工作量**：3-4 小时

---

### 子任务 3：修改函数调用逻辑

**目标**：修改函数调用逻辑，支持传递字符串参数

**步骤**：
1. 修改 `parseArithmeticFactor` 中的函数调用逻辑
2. 识别需要字符串参数的函数（`substr` 和 `index`）
3. 修改 `evaluateArithmeticFunction` 函数签名，接受 `[]ArithmeticFunctionArg`
4. 在 `evaluateArithmeticFunction` 中：
   - 对于普通函数，提取数字参数
   - 对于需要字符串参数的函数，提取字符串参数和数字参数
   - 调用相应的函数（`evaluateArithmeticFunction` 或 `evaluateArithmeticFunctionWithStrings`）
5. 确保向后兼容（现有函数仍正常工作）
6. 添加单元测试

**验收标准**：
- [ ] 函数调用逻辑能够正确识别函数类型
- [ ] 能够正确传递字符串参数和数字参数
- [ ] 现有函数（abs, min, max 等）仍然正常工作
- [ ] 所有现有测试仍然通过
- [ ] 添加新的单元测试覆盖函数调用逻辑

**预计工作量**：2-3 小时

---

### 子任务 4：实现 substr 函数

**目标**：完善 substr 函数的实现，确保与 bash 行为一致

**步骤**：
1. 完善 `evaluateArithmeticFunctionWithStrings` 中的 `substr` 实现
2. 处理边界情况：
   - 负数索引（从末尾开始）
   - 超出范围的索引
   - 长度为 0 或负数
3. 确保与 bash 行为一致：
   - 索引从 1 开始（bash 的行为）
   - 负数索引从末尾开始
4. 添加单元测试：
   - 基本功能测试
   - 边界情况测试
   - 负数索引测试
   - 超出范围测试

**验收标准**：
- [ ] substr 函数能够正确提取子字符串
- [ ] 正确处理所有边界情况
- [ ] 与 bash 行为一致
- [ ] 单元测试全部通过

**预计工作量**：2-3 小时

---

### 子任务 5：实现 index 函数

**目标**：完善 index 函数的实现，确保与 bash 行为一致

**步骤**：
1. 完善 `evaluateArithmeticFunctionWithStrings` 中的 `index` 实现
2. 处理边界情况：
   - 未找到子字符串（返回 0）
   - 空字符串参数
   - 多个匹配（返回第一个）
3. 确保与 bash 行为一致：
   - 索引从 1 开始（bash 的行为）
   - 未找到返回 0
4. 添加单元测试：
   - 基本功能测试
   - 边界情况测试
   - 未找到测试
   - 多个匹配测试

**验收标准**：
- [ ] index 函数能够正确查找子字符串位置
- [ ] 正确处理所有边界情况
- [ ] 与 bash 行为一致
- [ ] 单元测试全部通过

**预计工作量**：2-3 小时

---

### 子任务 6：集成测试和文档

**目标**：完成集成测试，更新文档

**步骤**：
1. 添加完整的集成测试用例：
   - 测试 substr 和 index 函数的基本用法
   - 测试通过变量展开传递字符串参数
   - 测试嵌套函数调用
   - 测试与其他算术函数的组合使用
2. 运行所有测试，确保没有回归
3. 更新文档：
   - 更新 REFACTOR_PLAN.md，标记任务为已完成
   - 更新代码注释
   - 添加使用示例
4. 代码审查和优化

**验收标准**：
- [ ] 所有集成测试通过
- [ ] 所有现有测试仍然通过
- [ ] 文档已更新
- [ ] 代码已审查和优化

**预计工作量**：2-3 小时

---

## 总体预计工作量

- **总计**：12-18 小时
- **建议执行顺序**：按子任务编号顺序执行
- **建议执行方式**：每个子任务完成后，提交代码并运行测试，确保没有回归

## 风险评估

1. **向后兼容性风险**：修改参数解析器可能影响现有函数
   - **缓解措施**：充分测试现有函数，确保向后兼容

2. **字符串参数识别风险**：变量展开后的字符串可能难以识别
   - **缓解措施**：在变量展开阶段标记字符串参数

3. **性能影响**：字符串参数解析可能影响性能
   - **缓解措施**：优化解析逻辑，只在需要时解析字符串参数

## 依赖关系

- 子任务 1 → 子任务 2, 3, 4, 5, 6
- 子任务 2 → 子任务 3, 4, 5, 6
- 子任务 3 → 子任务 4, 5, 6
- 子任务 4, 5 → 子任务 6

## 注意事项

1. 每个子任务完成后，必须运行所有测试，确保没有回归
2. 每个子任务完成后，提交代码并更新文档
3. 如果遇到问题，及时调整方案
4. 保持代码风格一致
5. 遵循 TDD 原则（测试驱动开发）

